{"ast":null,"code":"'use strict';\n\nvar DEFAULT_SIZE = 50;\nvar DEFAULT_WIDTH = 2;\nvar LN_2 = Math.log(2);\nvar self = module.exports;\n\nvar helper = require('./helper'); // Triangle\n\n\nfunction kernel(x) {\n  return 1 - Math.abs(x);\n}\n/**\r\n * Get min and max value for the pdf, covering all arr data range while respecting options' data\r\n * @param arr\r\n * @param options\r\n * @returns {*}\r\n */\n\n\nmodule.exports.getUnifiedMinMax = function (arr, options) {\n  return self.getUnifiedMinMaxMulti([arr], options);\n};\n\nmodule.exports.getUnifiedMinMaxMulti = function (arrMulti, options) {\n  options = options || {};\n  var relaxMin = false;\n  var relaxMax = false;\n  var width = helper.isNumber(options.width) ? options.width : DEFAULT_WIDTH;\n  var size = helper.isNumber(options.size) ? options.size : DEFAULT_SIZE;\n  var min = helper.isNumber(options.min) ? options.min : (relaxMin = true, helper.findMinMulti(arrMulti));\n  var max = helper.isNumber(options.max) ? options.max : (relaxMax = true, helper.findMaxMulti(arrMulti));\n  var range = max - min;\n  var step = range / (size - 1); // Relax?\n\n  if (relaxMin) {\n    min = min - 2 * width * step;\n  }\n\n  if (relaxMax) {\n    max = max + 2 * width * step;\n  }\n\n  return {\n    min: min,\n    max: max\n  };\n};\n\nmodule.exports.create = function (arr, options) {\n  options = options || {};\n\n  if (!arr || arr.length === 0) {\n    return [];\n  }\n\n  var size = helper.isNumber(options.size) ? options.size : DEFAULT_SIZE;\n  var width = helper.isNumber(options.width) ? options.width : DEFAULT_WIDTH;\n  var normalizedMinMax = self.getUnifiedMinMax(arr, {\n    size: size,\n    width: width,\n    min: options.min,\n    max: options.max\n  });\n  var min = normalizedMinMax.min;\n  var max = normalizedMinMax.max;\n  var range = max - min;\n  var step = range / (size - 1);\n\n  if (range === 0) {\n    // Special case...\n    return [{\n      x: min,\n      y: 1\n    }];\n  } // Good to go\n\n\n  var buckets = [];\n\n  for (var i = 0; i < size; i++) {\n    buckets.push({\n      x: min + i * step,\n      y: 0\n    });\n  }\n\n  var xToBucket = function (x) {\n    return Math.floor((x - min) / step);\n  };\n\n  var partialArea = generatePartialAreas(kernel, width);\n  var fullArea = partialArea[width];\n  var c = partialArea[width - 1] - partialArea[width - 2];\n  var initalValue = 0;\n  arr.forEach(function (x) {\n    var bucket = xToBucket(x); // Totally outside?\n\n    if (bucket + width < 0 || bucket - width >= buckets.length) {\n      return;\n    }\n\n    var start = Math.max(bucket - width, 0);\n    var mid = bucket;\n    var end = Math.min(bucket + width, buckets.length - 1);\n    var leftBlockCount = start - (bucket - width);\n    var rightBlockCount = bucket + width - end;\n    var spilledAreaLeft = partialArea[-width - 1 + leftBlockCount] || 0;\n    var spilledAreaRight = partialArea[-width - 1 + rightBlockCount] || 0;\n    var weight = fullArea / (fullArea - spilledAreaLeft - spilledAreaRight);\n\n    if (leftBlockCount > 0) {\n      initalValue += weight * (leftBlockCount - 1) * c;\n    } // Add grads\n\n\n    var startGradPos = Math.max(0, bucket - width + 1);\n\n    if (helper.inside(0, buckets.length - 1, startGradPos)) {\n      buckets[startGradPos].y += weight * 1 * c;\n    }\n\n    if (helper.inside(0, buckets.length - 1, mid + 1)) {\n      buckets[mid + 1].y -= weight * 2 * c;\n    }\n\n    if (helper.inside(0, buckets.length - 1, end + 1)) {\n      buckets[end + 1].y += weight * 1 * c;\n    }\n  });\n  var accumulator = initalValue;\n  var gradAccumulator = 0;\n  var area = 0;\n  buckets.forEach(function (bucket) {\n    gradAccumulator += bucket.y;\n    accumulator += gradAccumulator;\n    bucket.y = accumulator;\n    area += accumulator;\n  }); // Normalize\n\n  if (area > 0) {\n    buckets.forEach(function (bucket) {\n      bucket.y /= area;\n    });\n  }\n\n  return buckets;\n};\n\nfunction generatePartialAreas(kernel, width) {\n  var partialAreas = {};\n  var accumulator = 0;\n\n  for (var i = -width; i <= width; i++) {\n    accumulator += kernel(i / width);\n    partialAreas[i] = accumulator;\n  }\n\n  return partialAreas;\n}\n\nmodule.exports.getExpectedValueFromPdf = function (pdf) {\n  if (!pdf || pdf.length === 0) {\n    return undefined;\n  }\n\n  var expected = 0;\n  pdf.forEach(function (obj) {\n    expected += obj.x * obj.y;\n  });\n  return expected;\n};\n\nmodule.exports.getXWithLeftTailArea = function (pdf, area) {\n  if (!pdf || pdf.length === 0) {\n    return undefined;\n  }\n\n  var accumulator = 0;\n  var last = 0;\n\n  for (var i = 0; i < pdf.length; i++) {\n    last = i;\n    accumulator += pdf[i].y;\n\n    if (accumulator >= area) {\n      break;\n    }\n  }\n\n  return pdf[last].x;\n};\n\nmodule.exports.getPerplexity = function (pdf) {\n  if (!pdf || pdf.length === 0) {\n    return undefined;\n  }\n\n  var entropy = 0;\n  pdf.forEach(function (obj) {\n    var ln = Math.log(obj.y);\n\n    if (isFinite(ln)) {\n      entropy += obj.y * ln;\n    }\n  });\n  entropy = -entropy / LN_2;\n  return Math.pow(2, entropy);\n};","map":{"version":3,"sources":["D:/SQL/sqlindex2/sql/frontend/node_modules/pdfast/src/index.js"],"names":["DEFAULT_SIZE","DEFAULT_WIDTH","LN_2","Math","log","self","module","exports","helper","require","kernel","x","abs","getUnifiedMinMax","arr","options","getUnifiedMinMaxMulti","arrMulti","relaxMin","relaxMax","width","isNumber","size","min","findMinMulti","max","findMaxMulti","range","step","create","length","normalizedMinMax","y","buckets","i","push","xToBucket","floor","partialArea","generatePartialAreas","fullArea","c","initalValue","forEach","bucket","start","mid","end","leftBlockCount","rightBlockCount","spilledAreaLeft","spilledAreaRight","weight","startGradPos","inside","accumulator","gradAccumulator","area","partialAreas","getExpectedValueFromPdf","pdf","undefined","expected","obj","getXWithLeftTailArea","last","getPerplexity","entropy","ln","isFinite","pow"],"mappings":"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","sourcesContent":["'use strict';\r\n\r\nvar DEFAULT_SIZE = 50;\r\nvar DEFAULT_WIDTH = 2;\r\n\r\nvar LN_2 = Math.log(2);\r\nvar self = module.exports;\r\n\r\nvar helper = require('./helper');\r\n\r\n// Triangle\r\nfunction kernel(x) {\r\n  return 1 - Math.abs(x);\r\n}\r\n\r\n/**\r\n * Get min and max value for the pdf, covering all arr data range while respecting options' data\r\n * @param arr\r\n * @param options\r\n * @returns {*}\r\n */\r\nmodule.exports.getUnifiedMinMax = function (arr, options) {\r\n  return self.getUnifiedMinMaxMulti([arr], options);\r\n};\r\n\r\nmodule.exports.getUnifiedMinMaxMulti = function (arrMulti, options) {\r\n  options = options || {};\r\n\r\n  var relaxMin = false;\r\n  var relaxMax = false;\r\n\r\n  var width = helper.isNumber(options.width) ? options.width : DEFAULT_WIDTH;\r\n  var size = helper.isNumber(options.size) ? options.size : DEFAULT_SIZE;\r\n  var min = helper.isNumber(options.min) ? options.min : (relaxMin = true, helper.findMinMulti(arrMulti));\r\n  var max = helper.isNumber(options.max) ? options.max : (relaxMax = true, helper.findMaxMulti(arrMulti));\r\n\r\n  var range = max - min;\r\n  var step = range / (size - 1);\r\n\r\n  // Relax?\r\n  if (relaxMin) {\r\n    min = min - 2 * width * step;\r\n  }\r\n  if (relaxMax) {\r\n    max = max + 2 * width * step;\r\n  }\r\n\r\n  return {\r\n    min: min,\r\n    max: max\r\n  };\r\n};\r\n\r\nmodule.exports.create = function (arr, options) {\r\n  options = options || {};\r\n\r\n  if (!arr || (arr.length === 0)) {\r\n    return [];\r\n  }\r\n\r\n  var size = helper.isNumber(options.size) ? options.size : DEFAULT_SIZE;\r\n  var width = helper.isNumber(options.width) ? options.width : DEFAULT_WIDTH;\r\n  var normalizedMinMax = self.getUnifiedMinMax(arr, {\r\n    size: size,\r\n    width: width,\r\n    min: options.min,\r\n    max: options.max\r\n  });\r\n\r\n  var min = normalizedMinMax.min;\r\n  var max = normalizedMinMax.max;\r\n\r\n  var range = max - min;\r\n  var step = range / (size - 1);\r\n  if (range === 0) {\r\n    // Special case...\r\n    return [{x: min, y: 1}];\r\n  }\r\n\r\n  // Good to go\r\n\r\n  var buckets = [];\r\n  for (var i = 0; i < size; i++) {\r\n    buckets.push({\r\n      x: min + i * step,\r\n      y: 0\r\n    });\r\n  }\r\n\r\n  var xToBucket = function (x) {\r\n    return Math.floor((x - min) / step);\r\n  };\r\n\r\n  var partialArea = generatePartialAreas(kernel, width);\r\n  var fullArea = partialArea[width];\r\n  var c = partialArea[width-1] - partialArea[width-2];\r\n\r\n  var initalValue = 0;\r\n  arr.forEach(function (x) {\r\n    var bucket = xToBucket(x);\r\n\r\n    // Totally outside?\r\n    if ((bucket + width < 0) || (bucket - width >= buckets.length)) {\r\n      return;\r\n    }\r\n\r\n    var start = Math.max(bucket - width, 0);\r\n    var mid = bucket;\r\n    var end = Math.min(bucket + width, buckets.length - 1);\r\n\r\n    var leftBlockCount = start - (bucket - width);\r\n    var rightBlockCount = (bucket + width) - end;\r\n    var spilledAreaLeft = partialArea[-width-1 + leftBlockCount] || 0;\r\n    var spilledAreaRight = partialArea[-width-1 + rightBlockCount] || 0;\r\n    var weight = fullArea / (fullArea - spilledAreaLeft - spilledAreaRight);\r\n\r\n    if (leftBlockCount > 0) {\r\n      initalValue += weight * (leftBlockCount - 1) * c;\r\n    }\r\n\r\n    // Add grads\r\n    var startGradPos = Math.max(0, bucket-width+1);\r\n    if (helper.inside(0, buckets.length-1, startGradPos)) {\r\n      buckets[startGradPos].y += weight * 1 * c;\r\n    }\r\n    if (helper.inside(0, buckets.length-1, mid + 1)) {\r\n      buckets[mid + 1].y -= weight * 2 * c;\r\n    }\r\n    if (helper.inside(0, buckets.length-1, end + 1)) {\r\n      buckets[end + 1].y += weight * 1 * c;\r\n    }\r\n  });\r\n\r\n  var accumulator = initalValue;\r\n  var gradAccumulator = 0;\r\n  var area = 0;\r\n  buckets.forEach(function (bucket) {\r\n    gradAccumulator += bucket.y;\r\n    accumulator += gradAccumulator;\r\n\r\n    bucket.y = accumulator;\r\n    area += accumulator;\r\n  });\r\n\r\n  // Normalize\r\n  if (area > 0) {\r\n    buckets.forEach(function (bucket) {\r\n      bucket.y /= area;\r\n    });\r\n  }\r\n\r\n  return buckets;\r\n};\r\n\r\nfunction generatePartialAreas(kernel, width) {\r\n  var partialAreas = {};\r\n\r\n  var accumulator = 0;\r\n  for (var i = -width; i <= width; i++) {\r\n    accumulator += kernel(i/width);\r\n    partialAreas[i] = accumulator;\r\n  }\r\n\r\n  return partialAreas;\r\n}\r\n\r\nmodule.exports.getExpectedValueFromPdf = function (pdf) {\r\n  if (!pdf || (pdf.length === 0)) {\r\n    return undefined;\r\n  }\r\n\r\n  var expected = 0;\r\n\r\n  pdf.forEach(function (obj) {\r\n    expected += obj.x * obj.y;\r\n  });\r\n\r\n  return expected;\r\n};\r\n\r\nmodule.exports.getXWithLeftTailArea = function (pdf, area) {\r\n  if (!pdf || (pdf.length === 0)) {\r\n    return undefined;\r\n  }\r\n\r\n  var accumulator = 0;\r\n  var last = 0;\r\n  for (var i = 0; i < pdf.length; i++) {\r\n    last = i;\r\n    accumulator += pdf[i].y;\r\n\r\n    if (accumulator >= area) {\r\n      break;\r\n    }\r\n  }\r\n\r\n  return pdf[last].x;\r\n};\r\n\r\nmodule.exports.getPerplexity = function (pdf) {\r\n  if (!pdf || (pdf.length === 0)) {\r\n    return undefined;\r\n  }\r\n\r\n  var entropy = 0;\r\n  pdf.forEach(function (obj) {\r\n    var ln = Math.log(obj.y);\r\n\r\n    if (isFinite(ln)) {\r\n      entropy += obj.y * ln;\r\n    }\r\n  });\r\n  entropy = -entropy / LN_2;\r\n\r\n  return Math.pow(2, entropy);\r\n};\r\n"]},"metadata":{},"sourceType":"script"}