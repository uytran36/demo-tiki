{"ast":null,"code":"import { __assign } from \"tslib\";\nimport { deepMix, clone, debounce } from '@antv/util';\nimport Global from '../global';\nexport default {\n  getDefaultCfg: function getDefaultCfg() {\n    return {\n      updateEdge: true,\n      delegateStyle: {},\n      // 是否开启delegate\n      enableDelegate: false,\n      // 拖动节点过程中是否只改变 Combo 的大小，而不改变其结构\n      onlyChangeComboSize: false,\n      // 拖动过程中目标 combo 状态样式\n      comboActiveState: '',\n      selectedState: 'selected',\n      enableOptimize: false,\n      enableDebounce: false\n    };\n  },\n  getEvents: function getEvents() {\n    return {\n      'node:dragstart': 'onDragStart',\n      'node:drag': 'onDrag',\n      'node:dragend': 'onDragEnd',\n      'combo:dragenter': 'onDragEnter',\n      'combo:dragleave': 'onDragLeave',\n      'combo:drop': 'onDropCombo',\n      'node:drop': 'onDropNode',\n      'canvas:drop': 'onDropCanvas',\n      'node:touchstart': 'onTouchStart',\n      'node:touchmove': 'onTouchMove',\n      'node:touchend': 'onDragEnd'\n    };\n  },\n  validationCombo: function validationCombo(item) {\n    if (!this.origin || !item || item.destroyed) {\n      return false;\n    }\n\n    var type = item.getType();\n\n    if (type !== 'combo') {\n      return false;\n    }\n\n    return true;\n  },\n  onTouchStart: function onTouchStart(e) {\n    var self = this;\n\n    try {\n      var touches = e.originalEvent.touches;\n      var event1 = touches[0];\n      var event2 = touches[1];\n\n      if (event1 && event2) {\n        return;\n      }\n\n      e.preventDefault();\n    } catch (e) {\n      console.warn('Touch original event not exist!');\n    }\n\n    self.onDragStart(e);\n  },\n  onTouchMove: function onTouchMove(e) {\n    var self = this;\n\n    try {\n      var touches = e.originalEvent.touches;\n      var event1 = touches[0];\n      var event2 = touches[1];\n\n      if (event1 && event2) {\n        self.onDragEnd(e);\n        return;\n      }\n\n      e.preventDefault();\n    } catch (e) {\n      console.warn('Touch original event not exist!');\n    }\n\n    self.onDrag(e);\n  },\n\n  /**\n   * 开始拖动节点\n   * @param evt\n   */\n  onDragStart: function onDragStart(evt) {\n    var _this = this;\n\n    if (!this.shouldBegin.call(this, evt)) {\n      return;\n    }\n\n    var item = evt.item;\n\n    if (!item || item.destroyed || item.hasLocked()) {\n      return;\n    } // 拖动时，设置拖动元素的 capture 为false，则不拾取拖动的元素\n\n\n    var group = item.getContainer();\n    group.set('capture', false); // 如果拖动的target 是linkPoints / anchorPoints 则不允许拖动\n\n    var target = evt.target;\n\n    if (target) {\n      var isAnchorPoint = target.get('isAnchorPoint');\n\n      if (isAnchorPoint) {\n        return;\n      }\n    }\n\n    var graph = this.graph;\n    this.targets = []; // 将节点拖入到指定的 Combo\n\n    this.targetCombo = null; // 获取所有选中的元素\n\n    var nodes = graph.findAllByState('node', this.selectedState);\n    var currentNodeId = item.get('id'); // 当前拖动的节点是否是选中的节点\n\n    var dragNodes = nodes.filter(function (node) {\n      var nodeId = node.get('id');\n      return currentNodeId === nodeId;\n    }); // 只拖动当前节点\n\n    if (dragNodes.length === 0) {\n      this.targets.push(item);\n    } else if (nodes.length > 1) {\n      // 拖动多个节点\n      nodes.forEach(function (node) {\n        var locked = node.hasLocked();\n\n        if (!locked) {\n          _this.targets.push(node);\n        }\n      });\n    } else {\n      this.targets.push(item);\n    }\n\n    var beforeDragNodes = [];\n    this.targets.forEach(function (t) {\n      beforeDragNodes.push(clone(t.getModel()));\n    });\n    this.set('beforeDragNodes', beforeDragNodes);\n    this.hidenEdge = {};\n\n    if (this.get('updateEdge') && this.enableOptimize && !this.enableDelegate) {\n      this.targets.forEach(function (node) {\n        var edges = node.getEdges();\n        edges.forEach(function (edge) {\n          if (!edge.isVisible()) return;\n          _this.hidenEdge[edge.getID()] = true;\n          edge.hide();\n        });\n      });\n    }\n\n    this.origin = {\n      x: evt.x,\n      y: evt.y\n    };\n    this.point = {};\n    this.originPoint = {};\n  },\n\n  /**\n   * 持续拖动节点\n   * @param evt\n   */\n  onDrag: function onDrag(evt) {\n    var _this = this;\n\n    if (!this.origin) {\n      return;\n    }\n\n    if (!this.shouldUpdate(this, evt)) {\n      return;\n    }\n\n    if (this.get('enableDelegate')) {\n      this.updateDelegate(evt);\n    } else {\n      if (this.enableDebounce) this.debounceUpdate({\n        targets: this.targets,\n        graph: this.graph,\n        point: this.point,\n        origin: this.origin,\n        evt: evt,\n        updateEdge: this.get('updateEdge')\n      });else this.targets.map(function (target) {\n        _this.update(target, evt);\n      });\n    }\n  },\n\n  /**\n   * 拖动结束，设置拖动元素capture为true，更新元素位置，如果是拖动涉及到 combo，则更新 combo 结构\n   * @param evt\n   */\n  onDragEnd: function onDragEnd(evt) {\n    var _this = this;\n\n    if (!this.origin || !this.shouldEnd.call(this, evt)) {\n      return;\n    } // 拖动结束后，设置拖动元素 group 的 capture 为 true，允许拾取拖动元素\n\n\n    var item = evt.item;\n\n    if (item) {\n      var group = item.getContainer();\n      group.set('capture', true);\n    }\n\n    if (this.delegateRect) {\n      this.delegateRect.remove();\n      this.delegateRect = null;\n    }\n\n    this.updatePositions(evt);\n\n    if (this.get('updateEdge') && this.enableOptimize && !this.enableDelegate) {\n      this.targets.forEach(function (node) {\n        var edges = node.getEdges();\n        edges.forEach(function (edge) {\n          if (_this.hidenEdge[edge.getID()]) edge.show();\n          edge.refresh();\n        });\n      });\n    }\n\n    this.hidenEdge = {};\n    var graph = this.graph; // 拖动结束后，入栈\n\n    if (graph.get('enabledStack')) {\n      var stackData_1 = {\n        before: {\n          nodes: [],\n          edges: [],\n          combos: []\n        },\n        after: {\n          nodes: [],\n          edges: [],\n          combos: []\n        }\n      };\n      this.get('beforeDragNodes').forEach(function (model) {\n        stackData_1.before.nodes.push({\n          id: model.id,\n          x: model.x,\n          y: model.y\n        });\n      });\n      this.targets.forEach(function (target) {\n        var targetModel = target.getModel();\n        stackData_1.after.nodes.push({\n          id: targetModel.id,\n          x: targetModel.x,\n          y: targetModel.y\n        });\n      });\n      graph.pushStack('update', clone(stackData_1));\n    } // 拖动结束后emit事件，将当前操作的节点抛出去，目标节点为null\n\n\n    graph.emit('dragnodeend', {\n      items: this.targets,\n      targetItem: null\n    });\n    this.point = {};\n    this.origin = null;\n    this.originPoint = {};\n    this.targets.length = 0;\n    this.targetCombo = null;\n  },\n\n  /**\n   * 拖动过程中将节点放置到 combo 上\n   * @param evt\n   */\n  onDropCombo: function onDropCombo(evt) {\n    var item = evt.item;\n    if (!this.validationCombo(item)) return;\n    this.updatePositions(evt);\n    var graph = this.graph;\n\n    if (this.comboActiveState) {\n      graph.setItemState(item, this.comboActiveState, false);\n    }\n\n    this.targetCombo = item; // 拖动结束后是动态改变 Combo 大小还是将节点从 Combo 中删除\n\n    if (this.onlyChangeComboSize) {\n      // 拖动节点结束后，动态改变 Combo 的大小\n      graph.updateCombos();\n    } else {\n      var targetComboModel_1 = item.getModel();\n      this.targets.map(function (node) {\n        var nodeModel = node.getModel();\n\n        if (nodeModel.comboId !== targetComboModel_1.id) {\n          graph.updateComboTree(node, targetComboModel_1.id);\n        }\n      });\n      graph.updateCombo(item);\n    } // 将节点拖动到 combo 上面，emit事件抛出当前操作的节点及目标 combo\n\n\n    graph.emit('dragnodeend', {\n      items: this.targets,\n      targetItem: this.targetCombo\n    });\n  },\n  onDropCanvas: function onDropCanvas(evt) {\n    var graph = this.graph;\n    if (!this.targets || this.targets.length === 0) return;\n    this.updatePositions(evt);\n\n    if (this.onlyChangeComboSize) {\n      // 拖动节点结束后，动态改变 Combo 的大小\n      graph.updateCombos();\n    } else {\n      this.targets.map(function (node) {\n        // 拖动的节点有 comboId，即是从其他 combo 中拖出时才处理\n        var model = node.getModel();\n\n        if (model.comboId) {\n          graph.updateComboTree(node);\n        }\n      });\n    }\n  },\n\n  /**\n   * 拖动放置到某个 combo 中的子 node 上\n   * @param evt\n   */\n  onDropNode: function onDropNode(evt) {\n    if (!this.targets || this.targets.length === 0) return;\n    var self = this;\n    var item = evt.item;\n    this.updatePositions(evt);\n    var graph = self.graph;\n    var comboId = item.getModel().comboId;\n\n    if (comboId) {\n      if (this.onlyChangeComboSize) {\n        graph.updateCombos();\n      } else {\n        var combo = graph.findById(comboId);\n\n        if (self.comboActiveState) {\n          graph.setItemState(combo, self.comboActiveState, false);\n        }\n\n        this.targets.map(function (node) {\n          var nodeModel = node.getModel();\n\n          if (comboId !== nodeModel.comboId) {\n            graph.updateComboTree(node, comboId);\n          }\n        });\n        graph.updateCombo(combo);\n      }\n    } else {\n      this.targets.map(function (node) {\n        var model = node.getModel();\n\n        if (model.comboId) {\n          graph.updateComboTree(node);\n        }\n      });\n    } // 将节点拖动到另外个节点上面，emit 事件抛出当前操作的节点及目标节点\n\n\n    graph.emit('dragnodeend', {\n      items: this.targets,\n      targetItem: item\n    });\n  },\n\n  /**\n   * 将节点拖入到 Combo 中\n   * @param evt\n   */\n  onDragEnter: function onDragEnter(evt) {\n    var item = evt.item;\n    if (!this.validationCombo(item)) return;\n    var graph = this.graph;\n\n    if (this.comboActiveState) {\n      graph.setItemState(item, this.comboActiveState, true);\n    }\n  },\n\n  /**\n   * 将节点从 Combo 中拖出\n   * @param evt\n   */\n  onDragLeave: function onDragLeave(evt) {\n    var item = evt.item;\n    if (!this.validationCombo(item)) return;\n    var graph = this.graph;\n\n    if (this.comboActiveState) {\n      graph.setItemState(item, this.comboActiveState, false);\n    }\n  },\n  updatePositions: function updatePositions(evt) {\n    var _this = this;\n\n    if (!this.targets || this.targets.length === 0) return; // 当开启 delegate 时，拖动结束后需要更新所有已选中节点的位置\n\n    if (this.get('enableDelegate')) {\n      if (this.enableDebounce) this.debounceUpdate({\n        targets: this.targets,\n        graph: this.graph,\n        point: this.point,\n        origin: this.origin,\n        evt: evt,\n        updateEdge: this.get('updateEdge'),\n        updateFunc: this.update\n      });else this.targets.map(function (node) {\n        return _this.update(node, evt);\n      });\n    }\n  },\n\n  /**\n   * 更新节点\n   * @param item 拖动的节点实例\n   * @param evt\n   */\n  update: function update(item, evt) {\n    var origin = this.origin;\n    var model = item.get('model');\n    var nodeId = item.get('id');\n\n    if (!this.point[nodeId]) {\n      this.point[nodeId] = {\n        x: model.x || 0,\n        y: model.y || 0\n      };\n    }\n\n    var x = evt.x - origin.x + this.point[nodeId].x;\n    var y = evt.y - origin.y + this.point[nodeId].y;\n    var pos = {\n      x: x,\n      y: y\n    };\n\n    if (this.get('updateEdge')) {\n      this.graph.updateItem(item, pos, false);\n    } else {\n      item.updatePosition(pos);\n    }\n  },\n\n  /**\n   * 限流更新节点\n   * @param item 拖动的节点实例\n   * @param evt\n   */\n  debounceUpdate: debounce(function (event) {\n    var targets = event.targets,\n        graph = event.graph,\n        point = event.point,\n        origin = event.origin,\n        evt = event.evt,\n        updateEdge = event.updateEdge,\n        updateFunc = event.updateFunc;\n    targets.map(function (item) {\n      var model = item.get('model');\n      var nodeId = item.get('id');\n\n      if (!point[nodeId]) {\n        point[nodeId] = {\n          x: model.x || 0,\n          y: model.y || 0\n        };\n      }\n\n      var x = evt.x - origin.x + point[nodeId].x;\n      var y = evt.y - origin.y + point[nodeId].y;\n      var pos = {\n        x: x,\n        y: y\n      };\n\n      if (updateEdge) {\n        graph.updateItem(item, pos, false);\n      } else {\n        item.updatePosition(pos);\n      }\n    });\n  }, 50, true),\n\n  /**\n   * 更新拖动元素时的delegate\n   * @param {Event} e 事件句柄\n   * @param {number} x 拖动单个元素时候的x坐标\n   * @param {number} y 拖动单个元素时候的y坐标\n   */\n  updateDelegate: function updateDelegate(e) {\n    var graph = this.graph;\n\n    if (!this.delegateRect) {\n      // 拖动多个\n      var parent_1 = graph.get('group');\n      var attrs = deepMix({}, Global.delegateStyle, this.delegateStyle);\n\n      var _a = this.calculationGroupPosition(e),\n          cx = _a.x,\n          cy = _a.y,\n          width = _a.width,\n          height = _a.height,\n          minX = _a.minX,\n          minY = _a.minY;\n\n      this.originPoint = {\n        x: cx,\n        y: cy,\n        width: width,\n        height: height,\n        minX: minX,\n        minY: minY\n      }; // model上的x, y是相对于图形中心的，delegateShape是g实例，x,y是绝对坐标\n\n      this.delegateRect = parent_1.addShape('rect', {\n        attrs: __assign({\n          width: width,\n          height: height,\n          x: cx,\n          y: cy\n        }, attrs),\n        name: 'rect-delegate-shape'\n      });\n      this.delegate = this.delegateRect;\n      this.delegateRect.set('capture', false);\n    } else {\n      var clientX = e.x - this.origin.x + this.originPoint.minX;\n      var clientY = e.y - this.origin.y + this.originPoint.minY;\n      this.delegateRect.attr({\n        x: clientX,\n        y: clientY\n      });\n    }\n  },\n\n  /**\n   * 计算delegate位置，包括左上角左边及宽度和高度\n   * @memberof ItemGroup\n   * @return {object} 计算出来的delegate坐标信息及宽高\n   */\n  calculationGroupPosition: function calculationGroupPosition(evt) {\n    var nodes = this.targets;\n\n    if (nodes.length === 0) {\n      nodes.push(evt.item);\n    }\n\n    var minx = Infinity;\n    var maxx = -Infinity;\n    var miny = Infinity;\n    var maxy = -Infinity; // 获取已节点的所有最大最小x y值\n\n    for (var i = 0; i < nodes.length; i++) {\n      var element = nodes[i];\n      var bbox = element.getBBox();\n      var minX = bbox.minX,\n          minY = bbox.minY,\n          maxX = bbox.maxX,\n          maxY = bbox.maxY;\n\n      if (minX < minx) {\n        minx = minX;\n      }\n\n      if (minY < miny) {\n        miny = minY;\n      }\n\n      if (maxX > maxx) {\n        maxx = maxX;\n      }\n\n      if (maxY > maxy) {\n        maxy = maxY;\n      }\n    }\n\n    var x = Math.floor(minx);\n    var y = Math.floor(miny);\n    var width = Math.ceil(maxx) - Math.floor(minx);\n    var height = Math.ceil(maxy) - Math.floor(miny);\n    return {\n      x: x,\n      y: y,\n      width: width,\n      height: height,\n      minX: minx,\n      minY: miny\n    };\n  }\n};","map":{"version":3,"sources":["D:/LECONS-KHTN/CSDL Avancé/TH/sqlindex2/sql/frontend/node_modules/@antv/g6-pc/es/behavior/drag-node.js"],"names":["__assign","deepMix","clone","debounce","Global","getDefaultCfg","updateEdge","delegateStyle","enableDelegate","onlyChangeComboSize","comboActiveState","selectedState","enableOptimize","enableDebounce","getEvents","validationCombo","item","origin","destroyed","type","getType","onTouchStart","e","self","touches","originalEvent","event1","event2","preventDefault","console","warn","onDragStart","onTouchMove","onDragEnd","onDrag","evt","_this","shouldBegin","call","hasLocked","group","getContainer","set","target","isAnchorPoint","get","graph","targets","targetCombo","nodes","findAllByState","currentNodeId","dragNodes","filter","node","nodeId","length","push","forEach","locked","beforeDragNodes","t","getModel","hidenEdge","edges","getEdges","edge","isVisible","getID","hide","x","y","point","originPoint","shouldUpdate","updateDelegate","debounceUpdate","map","update","shouldEnd","delegateRect","remove","updatePositions","show","refresh","stackData_1","before","combos","after","model","id","targetModel","pushStack","emit","items","targetItem","onDropCombo","setItemState","updateCombos","targetComboModel_1","nodeModel","comboId","updateComboTree","updateCombo","onDropCanvas","onDropNode","combo","findById","onDragEnter","onDragLeave","updateFunc","pos","updateItem","updatePosition","event","parent_1","attrs","_a","calculationGroupPosition","cx","cy","width","height","minX","minY","addShape","name","delegate","clientX","clientY","attr","minx","Infinity","maxx","miny","maxy","i","element","bbox","getBBox","maxX","maxY","Math","floor","ceil"],"mappings":"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","sourcesContent":["import { __assign } from \"tslib\";\nimport { deepMix, clone, debounce } from '@antv/util';\nimport Global from '../global';\nexport default {\n  getDefaultCfg: function getDefaultCfg() {\n    return {\n      updateEdge: true,\n      delegateStyle: {},\n      // 是否开启delegate\n      enableDelegate: false,\n      // 拖动节点过程中是否只改变 Combo 的大小，而不改变其结构\n      onlyChangeComboSize: false,\n      // 拖动过程中目标 combo 状态样式\n      comboActiveState: '',\n      selectedState: 'selected',\n      enableOptimize: false,\n      enableDebounce: false\n    };\n  },\n  getEvents: function getEvents() {\n    return {\n      'node:dragstart': 'onDragStart',\n      'node:drag': 'onDrag',\n      'node:dragend': 'onDragEnd',\n      'combo:dragenter': 'onDragEnter',\n      'combo:dragleave': 'onDragLeave',\n      'combo:drop': 'onDropCombo',\n      'node:drop': 'onDropNode',\n      'canvas:drop': 'onDropCanvas',\n      'node:touchstart': 'onTouchStart',\n      'node:touchmove': 'onTouchMove',\n      'node:touchend': 'onDragEnd'\n    };\n  },\n  validationCombo: function validationCombo(item) {\n    if (!this.origin || !item || item.destroyed) {\n      return false;\n    }\n\n    var type = item.getType();\n\n    if (type !== 'combo') {\n      return false;\n    }\n\n    return true;\n  },\n  onTouchStart: function onTouchStart(e) {\n    var self = this;\n\n    try {\n      var touches = e.originalEvent.touches;\n      var event1 = touches[0];\n      var event2 = touches[1];\n\n      if (event1 && event2) {\n        return;\n      }\n\n      e.preventDefault();\n    } catch (e) {\n      console.warn('Touch original event not exist!');\n    }\n\n    self.onDragStart(e);\n  },\n  onTouchMove: function onTouchMove(e) {\n    var self = this;\n\n    try {\n      var touches = e.originalEvent.touches;\n      var event1 = touches[0];\n      var event2 = touches[1];\n\n      if (event1 && event2) {\n        self.onDragEnd(e);\n        return;\n      }\n\n      e.preventDefault();\n    } catch (e) {\n      console.warn('Touch original event not exist!');\n    }\n\n    self.onDrag(e);\n  },\n\n  /**\n   * 开始拖动节点\n   * @param evt\n   */\n  onDragStart: function onDragStart(evt) {\n    var _this = this;\n\n    if (!this.shouldBegin.call(this, evt)) {\n      return;\n    }\n\n    var item = evt.item;\n\n    if (!item || item.destroyed || item.hasLocked()) {\n      return;\n    } // 拖动时，设置拖动元素的 capture 为false，则不拾取拖动的元素\n\n\n    var group = item.getContainer();\n    group.set('capture', false); // 如果拖动的target 是linkPoints / anchorPoints 则不允许拖动\n\n    var target = evt.target;\n\n    if (target) {\n      var isAnchorPoint = target.get('isAnchorPoint');\n\n      if (isAnchorPoint) {\n        return;\n      }\n    }\n\n    var graph = this.graph;\n    this.targets = []; // 将节点拖入到指定的 Combo\n\n    this.targetCombo = null; // 获取所有选中的元素\n\n    var nodes = graph.findAllByState('node', this.selectedState);\n    var currentNodeId = item.get('id'); // 当前拖动的节点是否是选中的节点\n\n    var dragNodes = nodes.filter(function (node) {\n      var nodeId = node.get('id');\n      return currentNodeId === nodeId;\n    }); // 只拖动当前节点\n\n    if (dragNodes.length === 0) {\n      this.targets.push(item);\n    } else if (nodes.length > 1) {\n      // 拖动多个节点\n      nodes.forEach(function (node) {\n        var locked = node.hasLocked();\n\n        if (!locked) {\n          _this.targets.push(node);\n        }\n      });\n    } else {\n      this.targets.push(item);\n    }\n\n    var beforeDragNodes = [];\n    this.targets.forEach(function (t) {\n      beforeDragNodes.push(clone(t.getModel()));\n    });\n    this.set('beforeDragNodes', beforeDragNodes);\n    this.hidenEdge = {};\n\n    if (this.get('updateEdge') && this.enableOptimize && !this.enableDelegate) {\n      this.targets.forEach(function (node) {\n        var edges = node.getEdges();\n        edges.forEach(function (edge) {\n          if (!edge.isVisible()) return;\n          _this.hidenEdge[edge.getID()] = true;\n          edge.hide();\n        });\n      });\n    }\n\n    this.origin = {\n      x: evt.x,\n      y: evt.y\n    };\n    this.point = {};\n    this.originPoint = {};\n  },\n\n  /**\n   * 持续拖动节点\n   * @param evt\n   */\n  onDrag: function onDrag(evt) {\n    var _this = this;\n\n    if (!this.origin) {\n      return;\n    }\n\n    if (!this.shouldUpdate(this, evt)) {\n      return;\n    }\n\n    if (this.get('enableDelegate')) {\n      this.updateDelegate(evt);\n    } else {\n      if (this.enableDebounce) this.debounceUpdate({\n        targets: this.targets,\n        graph: this.graph,\n        point: this.point,\n        origin: this.origin,\n        evt: evt,\n        updateEdge: this.get('updateEdge')\n      });else this.targets.map(function (target) {\n        _this.update(target, evt);\n      });\n    }\n  },\n\n  /**\n   * 拖动结束，设置拖动元素capture为true，更新元素位置，如果是拖动涉及到 combo，则更新 combo 结构\n   * @param evt\n   */\n  onDragEnd: function onDragEnd(evt) {\n    var _this = this;\n\n    if (!this.origin || !this.shouldEnd.call(this, evt)) {\n      return;\n    } // 拖动结束后，设置拖动元素 group 的 capture 为 true，允许拾取拖动元素\n\n\n    var item = evt.item;\n\n    if (item) {\n      var group = item.getContainer();\n      group.set('capture', true);\n    }\n\n    if (this.delegateRect) {\n      this.delegateRect.remove();\n      this.delegateRect = null;\n    }\n\n    this.updatePositions(evt);\n\n    if (this.get('updateEdge') && this.enableOptimize && !this.enableDelegate) {\n      this.targets.forEach(function (node) {\n        var edges = node.getEdges();\n        edges.forEach(function (edge) {\n          if (_this.hidenEdge[edge.getID()]) edge.show();\n          edge.refresh();\n        });\n      });\n    }\n\n    this.hidenEdge = {};\n    var graph = this.graph; // 拖动结束后，入栈\n\n    if (graph.get('enabledStack')) {\n      var stackData_1 = {\n        before: {\n          nodes: [],\n          edges: [],\n          combos: []\n        },\n        after: {\n          nodes: [],\n          edges: [],\n          combos: []\n        }\n      };\n      this.get('beforeDragNodes').forEach(function (model) {\n        stackData_1.before.nodes.push({\n          id: model.id,\n          x: model.x,\n          y: model.y\n        });\n      });\n      this.targets.forEach(function (target) {\n        var targetModel = target.getModel();\n        stackData_1.after.nodes.push({\n          id: targetModel.id,\n          x: targetModel.x,\n          y: targetModel.y\n        });\n      });\n      graph.pushStack('update', clone(stackData_1));\n    } // 拖动结束后emit事件，将当前操作的节点抛出去，目标节点为null\n\n\n    graph.emit('dragnodeend', {\n      items: this.targets,\n      targetItem: null\n    });\n    this.point = {};\n    this.origin = null;\n    this.originPoint = {};\n    this.targets.length = 0;\n    this.targetCombo = null;\n  },\n\n  /**\n   * 拖动过程中将节点放置到 combo 上\n   * @param evt\n   */\n  onDropCombo: function onDropCombo(evt) {\n    var item = evt.item;\n    if (!this.validationCombo(item)) return;\n    this.updatePositions(evt);\n    var graph = this.graph;\n\n    if (this.comboActiveState) {\n      graph.setItemState(item, this.comboActiveState, false);\n    }\n\n    this.targetCombo = item; // 拖动结束后是动态改变 Combo 大小还是将节点从 Combo 中删除\n\n    if (this.onlyChangeComboSize) {\n      // 拖动节点结束后，动态改变 Combo 的大小\n      graph.updateCombos();\n    } else {\n      var targetComboModel_1 = item.getModel();\n      this.targets.map(function (node) {\n        var nodeModel = node.getModel();\n\n        if (nodeModel.comboId !== targetComboModel_1.id) {\n          graph.updateComboTree(node, targetComboModel_1.id);\n        }\n      });\n      graph.updateCombo(item);\n    } // 将节点拖动到 combo 上面，emit事件抛出当前操作的节点及目标 combo\n\n\n    graph.emit('dragnodeend', {\n      items: this.targets,\n      targetItem: this.targetCombo\n    });\n  },\n  onDropCanvas: function onDropCanvas(evt) {\n    var graph = this.graph;\n    if (!this.targets || this.targets.length === 0) return;\n    this.updatePositions(evt);\n\n    if (this.onlyChangeComboSize) {\n      // 拖动节点结束后，动态改变 Combo 的大小\n      graph.updateCombos();\n    } else {\n      this.targets.map(function (node) {\n        // 拖动的节点有 comboId，即是从其他 combo 中拖出时才处理\n        var model = node.getModel();\n\n        if (model.comboId) {\n          graph.updateComboTree(node);\n        }\n      });\n    }\n  },\n\n  /**\n   * 拖动放置到某个 combo 中的子 node 上\n   * @param evt\n   */\n  onDropNode: function onDropNode(evt) {\n    if (!this.targets || this.targets.length === 0) return;\n    var self = this;\n    var item = evt.item;\n    this.updatePositions(evt);\n    var graph = self.graph;\n    var comboId = item.getModel().comboId;\n\n    if (comboId) {\n      if (this.onlyChangeComboSize) {\n        graph.updateCombos();\n      } else {\n        var combo = graph.findById(comboId);\n\n        if (self.comboActiveState) {\n          graph.setItemState(combo, self.comboActiveState, false);\n        }\n\n        this.targets.map(function (node) {\n          var nodeModel = node.getModel();\n\n          if (comboId !== nodeModel.comboId) {\n            graph.updateComboTree(node, comboId);\n          }\n        });\n        graph.updateCombo(combo);\n      }\n    } else {\n      this.targets.map(function (node) {\n        var model = node.getModel();\n\n        if (model.comboId) {\n          graph.updateComboTree(node);\n        }\n      });\n    } // 将节点拖动到另外个节点上面，emit 事件抛出当前操作的节点及目标节点\n\n\n    graph.emit('dragnodeend', {\n      items: this.targets,\n      targetItem: item\n    });\n  },\n\n  /**\n   * 将节点拖入到 Combo 中\n   * @param evt\n   */\n  onDragEnter: function onDragEnter(evt) {\n    var item = evt.item;\n    if (!this.validationCombo(item)) return;\n    var graph = this.graph;\n\n    if (this.comboActiveState) {\n      graph.setItemState(item, this.comboActiveState, true);\n    }\n  },\n\n  /**\n   * 将节点从 Combo 中拖出\n   * @param evt\n   */\n  onDragLeave: function onDragLeave(evt) {\n    var item = evt.item;\n    if (!this.validationCombo(item)) return;\n    var graph = this.graph;\n\n    if (this.comboActiveState) {\n      graph.setItemState(item, this.comboActiveState, false);\n    }\n  },\n  updatePositions: function updatePositions(evt) {\n    var _this = this;\n\n    if (!this.targets || this.targets.length === 0) return; // 当开启 delegate 时，拖动结束后需要更新所有已选中节点的位置\n\n    if (this.get('enableDelegate')) {\n      if (this.enableDebounce) this.debounceUpdate({\n        targets: this.targets,\n        graph: this.graph,\n        point: this.point,\n        origin: this.origin,\n        evt: evt,\n        updateEdge: this.get('updateEdge'),\n        updateFunc: this.update\n      });else this.targets.map(function (node) {\n        return _this.update(node, evt);\n      });\n    }\n  },\n\n  /**\n   * 更新节点\n   * @param item 拖动的节点实例\n   * @param evt\n   */\n  update: function update(item, evt) {\n    var origin = this.origin;\n    var model = item.get('model');\n    var nodeId = item.get('id');\n\n    if (!this.point[nodeId]) {\n      this.point[nodeId] = {\n        x: model.x || 0,\n        y: model.y || 0\n      };\n    }\n\n    var x = evt.x - origin.x + this.point[nodeId].x;\n    var y = evt.y - origin.y + this.point[nodeId].y;\n    var pos = {\n      x: x,\n      y: y\n    };\n\n    if (this.get('updateEdge')) {\n      this.graph.updateItem(item, pos, false);\n    } else {\n      item.updatePosition(pos);\n    }\n  },\n\n  /**\n   * 限流更新节点\n   * @param item 拖动的节点实例\n   * @param evt\n   */\n  debounceUpdate: debounce(function (event) {\n    var targets = event.targets,\n        graph = event.graph,\n        point = event.point,\n        origin = event.origin,\n        evt = event.evt,\n        updateEdge = event.updateEdge,\n        updateFunc = event.updateFunc;\n    targets.map(function (item) {\n      var model = item.get('model');\n      var nodeId = item.get('id');\n\n      if (!point[nodeId]) {\n        point[nodeId] = {\n          x: model.x || 0,\n          y: model.y || 0\n        };\n      }\n\n      var x = evt.x - origin.x + point[nodeId].x;\n      var y = evt.y - origin.y + point[nodeId].y;\n      var pos = {\n        x: x,\n        y: y\n      };\n\n      if (updateEdge) {\n        graph.updateItem(item, pos, false);\n      } else {\n        item.updatePosition(pos);\n      }\n    });\n  }, 50, true),\n\n  /**\n   * 更新拖动元素时的delegate\n   * @param {Event} e 事件句柄\n   * @param {number} x 拖动单个元素时候的x坐标\n   * @param {number} y 拖动单个元素时候的y坐标\n   */\n  updateDelegate: function updateDelegate(e) {\n    var graph = this.graph;\n\n    if (!this.delegateRect) {\n      // 拖动多个\n      var parent_1 = graph.get('group');\n      var attrs = deepMix({}, Global.delegateStyle, this.delegateStyle);\n\n      var _a = this.calculationGroupPosition(e),\n          cx = _a.x,\n          cy = _a.y,\n          width = _a.width,\n          height = _a.height,\n          minX = _a.minX,\n          minY = _a.minY;\n\n      this.originPoint = {\n        x: cx,\n        y: cy,\n        width: width,\n        height: height,\n        minX: minX,\n        minY: minY\n      }; // model上的x, y是相对于图形中心的，delegateShape是g实例，x,y是绝对坐标\n\n      this.delegateRect = parent_1.addShape('rect', {\n        attrs: __assign({\n          width: width,\n          height: height,\n          x: cx,\n          y: cy\n        }, attrs),\n        name: 'rect-delegate-shape'\n      });\n      this.delegate = this.delegateRect;\n      this.delegateRect.set('capture', false);\n    } else {\n      var clientX = e.x - this.origin.x + this.originPoint.minX;\n      var clientY = e.y - this.origin.y + this.originPoint.minY;\n      this.delegateRect.attr({\n        x: clientX,\n        y: clientY\n      });\n    }\n  },\n\n  /**\n   * 计算delegate位置，包括左上角左边及宽度和高度\n   * @memberof ItemGroup\n   * @return {object} 计算出来的delegate坐标信息及宽高\n   */\n  calculationGroupPosition: function calculationGroupPosition(evt) {\n    var nodes = this.targets;\n\n    if (nodes.length === 0) {\n      nodes.push(evt.item);\n    }\n\n    var minx = Infinity;\n    var maxx = -Infinity;\n    var miny = Infinity;\n    var maxy = -Infinity; // 获取已节点的所有最大最小x y值\n\n    for (var i = 0; i < nodes.length; i++) {\n      var element = nodes[i];\n      var bbox = element.getBBox();\n      var minX = bbox.minX,\n          minY = bbox.minY,\n          maxX = bbox.maxX,\n          maxY = bbox.maxY;\n\n      if (minX < minx) {\n        minx = minX;\n      }\n\n      if (minY < miny) {\n        miny = minY;\n      }\n\n      if (maxX > maxx) {\n        maxx = maxX;\n      }\n\n      if (maxY > maxy) {\n        maxy = maxY;\n      }\n    }\n\n    var x = Math.floor(minx);\n    var y = Math.floor(miny);\n    var width = Math.ceil(maxx) - Math.floor(minx);\n    var height = Math.ceil(maxy) - Math.floor(miny);\n    return {\n      x: x,\n      y: y,\n      width: width,\n      height: height,\n      minX: minx,\n      minY: miny\n    };\n  }\n};"]},"metadata":{},"sourceType":"module"}